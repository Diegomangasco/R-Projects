---
title: "Lezione Tidyverse"
output: html_document
---
```{r}
library(tidyverse)
```

#Caricamento Dati

```{r}
url <- 'https://www.epicentro.iss.it/coronavirus/open-data/covid_19-iss.xlsx'
file = "covid_19.xlsx"
if( ! file.exists(file) ){
  download.file(url, "covid_19.xlsx")
}

```

#Leggere i dati

```{r}
library(magrittr)
library(readxl)
covid <- read_xlsx(file, "stato_clinico")
covid
```

#Riassettare i dati

```{r}
covid <- pivot_wider( covid, names_from = "STATO_CLINICO", 
             values_from = "CASI")
```

```{r}
pivot_longer( covid, cols = c("ASINTOMATICO", 
                              "CRITICO", "LIEVE", 
                              "PAUCI-SINTOMATICO"),
              names_to = "stato_clinico", 
              values_to = "numero")

```

#Trasformare/Manipolare/aggiustare

```{r}

mutate( covid, SESSO = factor(SESSO) )

#stessa operazione con l'operatore di pipe

covid %>% 
  mutate( SESSO = factor(SESSO) ) %>%
  mutate( AGE_GROUP = factor(AGE_GROUP) )

#posso fare piÃ¹ mutate insieme

covid %>% 
  mutate( iss_date = as.Date( iss_date, format = "%d/%M/%Y"),
    SESSO = factor(SESSO),
    AGE_GROUP = factor(AGE_GROUP),
    CASI = as.integer(CASI)
  )

#per riassegnare a covid aggiungo < a pipe

covid %<>% 
  mutate( iss_date = as.Date( iss_date, format = "%d/%M/%Y"),
    SESSO = factor(SESSO),
    AGE_GROUP = factor(AGE_GROUP),
    CASI = as.integer(CASI)
)

#bisogna trattare il caso <5 a parte, altrimenti il as.integer da errore

covid %<>% 
  mutate( CASI = if_else(CASI=="<5", "3", CASI)) %>% 
  mutate( CASI = as.integer((CASI))) %>% 
  mutate( AGE_GROUP = if_else(AGE_GROUP==">90", "90+", AGE_GROUP)) %>% 
  select( - iss_date ) %>% 
  filter( AGE_GROUP != "Non noto")

#con select cancello la colonna data (seleziono tutte le colonne che non sono data)

rename(PAUCI_SINTOMATICO = "PAUCI-SINTOMATICO")

mutate( CASI = ASINTOMATICO+CRITICO+LIEVE+SEVERO+PAUCI_SINTOMATICO)

```

#Sintesi di dati

```{r}
covid %>% 
  summarise( totale_casi = sum(CASI, na.rn = TRUE) )

covid %>% 
  group_by( AGE_GROUP ) %>% 
  summarise( totale_casi = sum(CASI, na.nr = TRUE) )

#l'operazione di summarise viene applicata per ogni gruppo

covid %>% 
  group_by( AGE_GROUP ) %>% 
  summarise( totale_casi = sum(CASI, na.nr = TRUE) ) %>% 
  arrange( desc( totale_casi ) )

#arrange ordina il dataframe secondo l'ordine di una colonna

covid %>% 
  group_by( AGE_GROUP ) %>% 
  summarise( prop_critici = sum(CRITICO+SEVERP, na.rn = TRUE) / sum(CASI, na.nr = TRUE) ) %>% 
  arrange( desc( prop_critici ) ) %>% 
  mutate( percentuale = paste0(round(prop_critici*100, 1), "%"))

#se alla fine della pipe si aggiunge %$%, indica che ogni colonna del dataframe sia una variabile accessibile, senza specificarla sempre come nomedataframe$colonna

covid %>% 
  mutate( AGE_GROUP = reorder( AGE_GROUP, desc( prop_critici ) ) )

#riordino i livelli in base ad un altra variabile in ordine decrescente

```





```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
